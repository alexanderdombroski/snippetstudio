<!doctype html>
<html>
	<head>
		<title>Snippet Details</title>
		<script>
			const vscode = acquireVsCodeApi();
		</script>
	</head>
	<body>
		<form id="snippetForm">
			<label for="snippetTitle">Title:</label>
			<input type="text" id="snippetTitle" name="snippetTitle" required />

			<label for="prefix">Prefix:</label>
			<input type="text" id="prefix" name="prefix" />

			<div id="scopeContainer">
				<label for="scope">Scope:</label>
				<input type="text" id="scope" name="scope" />
			</div>

			<details>
				<summary>Extra Configuration</summary>
				<input type="checkbox" name="isFileTemplate" id="isFileTemplate" />
				<label for="isFileTemplate">File Template</label>
				<div id="globContainer">
					<label for="include">Include:</label>
					<input type="text" name="include" id="include" />
					<label for="exclude">Exclude:</label>
					<input type="text" name="exclude" id="exclude" />
				</div>
				<label for="description">Description:</label>
				<textarea id="description" name="description"></textarea>
			</details>

			<button type="submit" id="saveButton">Save</button>

			<p>Snippet will be stored at:&nbsp;<span id="filepath"></span></p>
		</form>

		<script>
			// ---------- Handle form submission ----------
			let showScope;
			const saveButton = document.getElementById('saveButton');

			document.getElementById('snippetForm').addEventListener('submit', (event) => {
				event.preventDefault();
				const formData = new FormData(event.currentTarget);
				const data = {
					snippetTitle: formData.get('snippetTitle'),
					filepath: document.getElementById('filepath').innerText,
				};
				const desc = formData.get('description');
				if (desc) data.description = desc;
				const scope = formData.get('scope');
				if (showScope) data.scope = scope || 'global';
				const isFileTemplate = formData.get('isFileTemplate');
				if (isFileTemplate) data.isFileTemplate = isFileTemplate;
				const prefix = formData.get('prefix');
				if (prefix) data.prefix = prefix;
				const include = formData.get('include');
				if (include) data.include = include;
				const exclude = formData.get('exclude');
				if (exclude) data.exclude = exclude;

				vscode.postMessage({ command: 'updateSnippetData', data });
			});

			// ---------- Init form ----------
			window.addEventListener('message', (event) => {
				if (!event.origin.startsWith('vscode-webview://')) {
					console.warn('Received message from an unexpected origin:', event.origin);
					return;
				}

				const message = event.data;
				switch (message.command) {
					case 'filterFields':
						showScope = message.showScope;
						document.getElementById('scopeContainer').style.display = showScope ? 'block' : 'none';
						document.getElementById('globContainer').style.display = message.showGlob
							? 'block'
							: 'none';
						break;

					case 'setIsEditorActive':
						saveButton.ariaDisabled = String(!message.data);
						saveButton.disabled = !message.data;
						break;

					case 'initForm':
						const {
							snippetTitle,
							prefix,
							isFileTemplate,
							include,
							exclude,
							scope,
							description,
							filepath,
						} = message.data;
						document.getElementById('snippetTitle').value = snippetTitle;
						if (prefix) {
							const prefixInput = document.getElementById('prefix');
							prefixInput.value = Array.isArray(prefix) ? prefix.join(',') : prefix;
						}
						if (isFileTemplate) {
							document.getElementById('isFileTemplate').checked = true;
						}
						if (description) {
							document.getElementById('description').innerText = description;
						}
						if (showScope && scope) {
							document.getElementById('scope').value = scope;
						}
						if (include) {
							document.getElementById('include').value = include;
						}
						if (exclude) {
							document.getElementById('exclude').value = exclude;
						}
						document.getElementById('filepath').innerText = filepath;
						break;

					default:
						break;
				}
			});

			// ---------- Cache form ----------
			function listenForChanges(id) {
				document.getElementById(id).addEventListener('input', (event) => {
					debounce((event) => {
						const data = event.target.value.trim();
						vscode.postMessage({
							command: 'updatePartialSnippetData',
							data: { data, type: id },
						});
					}, 300)(event);
				});
			}
			listenForChanges('snippetTitle');
			listenForChanges('prefix');
			listenForChanges('description');
			listenForChanges('scope');
			listenForChanges('isFileTemplate');
			listenForChanges('include');
			listenForChanges('exclude');

			function debounce(func, delay) {
				let timeoutId;
				return function (...args) {
					clearTimeout(timeoutId);
					timeoutId = setTimeout(() => {
						func.apply(this, args);
					}, delay);
				};
			}
		</script>

		<style>
			body {
				--spacing-sm: 0.8rem;
				background-color: var(--vscode-sideBar-background);
				margin: 0;

				& form {
					display: flex;
					flex-direction: column;

					& label {
						display: block;
						font-size: 0.9rem;
						color: var(--vscode-sideBar-foreground);
						margin-top: var(--spacing-sm);

						&[for='isFileTemplate'] {
							display: inline;
							vertical-align: middle;
						}
					}

					& input,
					& textarea {
						display: block;
						background-color: var(--vscode-settings-textInputBackground);
						color: var(--vscode-settings-textInputForeground);
						border-color: var(--vscode-settings-textInputBorder);
						border-style: solid;
						border-radius: 5px;
						margin-top: 2px;
						width: 100%;
					}

					& input {
						font-size: 0.7rem;
						&[type='checkbox'] {
							width: unset;
							display: inline;
							margin: 0;
							margin-right: 4px;
							vertical-align: middle;
						}
					}
					& textarea {
						font-size: 0.6rem;
						margin-bottom: var(--spacing-sm);
					}

					/* ----- Extra Configuration ----- */
					& details {
						& summary {
							margin-block: var(--spacing-sm);
							cursor: pointer;
							text-align: center;

							&::-webkit-details-marker {
								display: none;
							}
							&::marker {
								content: '';
							}
							&::before {
								margin-right: 0.8em;
								content: '[+]';
							}
						}
						&[open] {
							summary::before {
								content: '[\2013]';
							}
						}
					}

					/* ----- Submit Button ----- */
					& button {
						background-color: var(--vscode-button-background);
						color: var(--vscode-button-foreground);
						border-color: var(--vscode-button-border);
						&:hover {
							background-color: var(--vscode-button-hoverBackground);
						}
						&:disabled {
							color: var(--vscode-button-secondaryForeground);
							background-color: var(--vscode-button-secondaryBackground);
						}
					}

					/* ----- Snippet Location ----- */
					& p {
						font-style: italic;
						font-size: 0.5rem;
						& span {
							word-break: break-all;
						}
					}
				}
			}
		</style>
	</body>
</html>
